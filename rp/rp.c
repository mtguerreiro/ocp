/*
 * @file rp.c
 *
 * @brief Request processor (RP).
 */

//=============================================================================
/*-------------------------------- Includes ---------------------------------*/
//=============================================================================
#include "rp.h"

#include "string.h"
//=============================================================================

//=============================================================================
/*------------------------------- Definitions -------------------------------*/
//=============================================================================


//=============================================================================

//=============================================================================
/*-------------------------------- Functions --------------------------------*/
//=============================================================================
//-----------------------------------------------------------------------------
void rpInitialize(rpctx_t *rp, rpuint_t maxid, rphandle_t *buffer){

    uint32_t i;

    rp->handle = buffer;
    rp->maxid = maxid;

    for( i = 0; i < maxid; i++ ){
        rp->handle[i] = 0;
    }
}
//-----------------------------------------------------------------------------
rpint_t rpRegisterHandle(rpctx_t *rp, rpid_t id, rphandle_t handle){

    if( id >= rp->maxid ) return RP_ERR_INVALID_ID;

    rp->handle[id] = handle;

    return 0;
}
//-----------------------------------------------------------------------------
rpint_t rpRequest(rpctx_t *rp, void *in, rpuint_t insize, void **out, rpuint_t maxoutsize){

    char *p;
    rpint_t status;
    rpuint_t cmd;

    if( insize < sizeof(cmd) ) return RP_ERR_INVALID_SIZE;

    memcpy( (void *)&cmd, in, sizeof(cmd) );

    if( cmd >= rp->maxid ) return RP_ERR_INVALID_ID;

    if( rp->handle[cmd] == 0 ) return RP_ERR_NO_HANDLE;

    p = (char *)in + sizeof(cmd);
    status = rp->handle[cmd]( (void *)p, insize - sizeof(cmd), out, maxoutsize);

    return status;
}
//-----------------------------------------------------------------------------
//=============================================================================
